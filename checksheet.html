<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Construction Check Sheet (Offline Sync + QR Auth)</title>

<!-- Optional: jsQR fallback for browsers without BarcodeDetector -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jsqr/1.4.0/jsQR.min.js"></script>

<style>
  body { font-family: Arial, Helvetica, sans-serif; background: #f1f1f1; padding: 20px; }
  .container { max-width: 900px; margin: auto; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 0 10px #ccc; }
  h2 { text-align: center; margin-bottom: 20px; }
  .section-header { background: #c8e6c9; padding: 12px 8px 8px 8px; font-weight: bold; border-radius: 4px; margin-top: 20px; }

  /* QR lock overlay */
  .locked-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.75); display:flex; align-items:center; justify-content:center; z-index:9999; }
  #qr-area { background: white; padding: 20px; border-radius: 12px; text-align: center; max-width: 360px; }
  #qr-video, #fallback-video { width: 300px; border-radius: 8px; }
  .disabled * { pointer-events: none; opacity: 0.45; }
  .row { display: grid; grid-template-columns: 1fr 120px 120px; gap: 10px; padding: 6px 0; border-bottom: 1px solid #ddd; }
  .row label { font-weight: 500; }
  input[type="checkbox"] { transform: scale(1.2); margin-left: 8px; }
  input[type="text"], input[type="date"] { width: 100%; padding: 6px; }
  textarea { width: 100%; padding: 10px; height: 80px; }
  .signoff { background: #a5d6a7; border: 2px solid #388e3c; border-radius: 6px; padding: 12px; margin-top: 8px; display: flex; gap: 20px; align-items: center; flex-wrap: wrap; }
  .submit-container { margin-top: 20px; text-align: center; }
  button.primary { background: #1976d2; color: white; padding: 10px 16px; border-radius: 8px; border: none; cursor: pointer; }
  button.ghost { background: none; border: 1px solid #ccc; padding: 8px 12px; border-radius: 6px; cursor: pointer; }
</style>
</head>
<body>

<!-- QR AUTH LOCK SCREEN -->
<div id="lockscreen" class="locked-overlay">
  <div id="qr-area">
    <h3>Scan QR Code to Unlock</h3>
    <video id="qr-video" autoplay playsinline></video>
    <p id="qr-status">Waiting for scan...</p>
    <div style="margin-top:12px;"><button id="cancelScan" class="ghost">Cancel</button></div>
  </div>
</div>

<form id="checksheet-form">
<div class="container disabled" id="sheet-container">
  <h2>Construction Check-sheet</h2>

  <div class="row">
    <label for="building">Building Number</label>
    <input type="text" id="building" name="building" />
    <div></div>
  </div>

  <div class="row">
    <label for="phase">Phase</label>
    <input type="text" id="phase" name="phase" />
    <div></div>
  </div>

  <div class="row">
    <label for="foreman">Foreman</label>
    <input type="text" id="foreman" name="foreman" />
    <div></div>
  </div>

  <!-- minimal subset of original form for brevity; you can re-add sections as needed -->

  <div class="submit-container">
    <button type="button" id="forceSync" class="primary">SUBMIT (force sync)</button>
  </div>

  <div style="margin-top:12px; font-size:13px;" id="syncStatus">Status: Not synced</div>
</div>
</form>

<script>
// ======================== CONFIG ===========================
const SAVE_URL = "/autosave-checksheet";           // Server endpoint (replace)
const REQUIRED_QR_VALUE = "AUTHORIZED_USER";       // Value expected from QR (replace)
const SAVE_INTERVAL_MS = 1500;                      // Save throttle
// ============================================================

// State
let saveTimer = null;
let lastSavedPayload = "";
let syncQueue = JSON.parse(localStorage.getItem('checksheet_queue') || '[]');
let editingUnlocked = false;
let qrStream = null;

// Elements
const qrVideo = document.getElementById('qr-video');            // <video> used for QR scanning
const lockscreen = document.getElementById('lockscreen');
const qrStatus = document.getElementById('qr-status');
const cancelScanBtn = document.getElementById('cancelScan');
const sheetContainer = document.getElementById('sheet-container');
const syncStatusEl = document.getElementById('syncStatus');
const form = document.getElementById('checksheet-form');
const forceSyncBtn = document.getElementById('forceSync');

// -------- QR SCAN (BarcodeDetector preferred, fallback to jsQR) ----------
async function startQRScan() {
  qrStatus.textContent = 'Requesting camera...';
  try {
    qrStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
    qrVideo.srcObject = qrStream;
    qrVideo.play();

    const hasBarcodeDetector = ('BarcodeDetector' in window) && (window.BarcodeDetector);
    if (hasBarcodeDetector) {
      const detector = new BarcodeDetector({ formats: ['qr_code'] });
      qrStatus.textContent = 'Scanning (native detector)...';

      const tick = async () => {
        try {
          const barcodes = await detector.detect(qrVideo);
          if (barcodes && barcodes.length > 0) {
            handleQrValue(barcodes[0].rawValue);
            return;
          }
        } catch (e) {
          // fall through to continue scanning
        }
        requestAnimationFrame(tick);
      };
      tick();
    } else {
      // fallback using jsQR
      qrStatus.textContent = 'Scanning (fallback)...';
      const canvas = document.createElement('canvas');
      const ctx = canvas.getContext('2d');

      const tick = () => {
        if (qrVideo.readyState === qrVideo.HAVE_ENOUGH_DATA) {
          canvas.width = qrVideo.videoWidth;
          canvas.height = qrVideo.videoHeight;
          ctx.drawImage(qrVideo, 0, 0, canvas.width, canvas.height);
          const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
          const code = jsQR(imageData.data, canvas.width, canvas.height);
          if (code) { handleQrValue(code.data); return; }
        }
        requestAnimationFrame(tick);
      };
      tick();
    }
  } catch (err) {
    qrStatus.textContent = 'Camera denied or error: ' + err.message;
  }
}

function stopQRScan() {
  if (qrStream) {
    qrStream.getTracks().forEach(t => t.stop());
    qrStream = null;
  }
}

function handleQrValue(value) {
  qrStatus.textContent = 'Scanned: ' + value;
  if (value === REQUIRED_QR_VALUE) {
    unlockEditing();
  } else {
    qrStatus.textContent = 'Unrecognized QR. Try again.';
    // keep scanning (or stop based on your policy) - we'll continue scanning
    // In this implementation we continue scanning so user can try again.
    requestAnimationFrame(startQRScan);
  }
}

cancelScanBtn.addEventListener('click', () => {
  stopQRScan();
  lockscreen.style.display = 'none';
  // keep sheet locked; user must reopen to scan again
});

function unlockEditing() {
  editingUnlocked = true;
  stopQRScan();
  lockscreen.style.display = 'none';
  sheetContainer.classList.remove('disabled');
  qrStatus.textContent = 'Unlocked';
  restoreLocal();
}

// Start scanning immediately when page loads
startQRScan();

// ------------------ FORM SERIALIZATION ---------------------
function collectFormData() {
  const data = {};
  const elements = form.querySelectorAll('input[type="text"], input[type="date"], input[type="checkbox"], textarea');
  elements.forEach(el => {
    const name = el.name || el.id;
    if (!name) return;
    if (el.type === 'checkbox') {
      if (!data[name]) data[name] = [];
      data[name].push(el.checked);
    } else {
      if (!data[name]) data[name] = [];
      data[name].push(el.value);
    }
  });
  return data;
}

// ----------------------- OFFLINE SAVE & SYNC ----------------------
function requestSave() {
  if (!editingUnlocked) return;
  if (saveTimer) clearTimeout(saveTimer);
  saveTimer = setTimeout(performSave, SAVE_INTERVAL_MS);
}

function performSave() {
  const payload = JSON.stringify(collectFormData());
  if (payload === lastSavedPayload) return;

  // local snapshot
  localStorage.setItem('checksheet_local', payload);

  if (!navigator.onLine) {
    enqueue(payload);
    updateSyncStatus('Offline – changes queued');
    return;
  }

  sendToServer(payload);
}

function sendToServer(payload) {
  updateSyncStatus('Saving...');
  fetch(SAVE_URL, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: payload
  }).then(r => {
    lastSavedPayload = payload;
    updateSyncStatus('Saved to server');
    processQueue();
  }).catch(err => {
    console.error('Save failed:', err);
    enqueue(payload);
    updateSyncStatus('Save failed – queued');
  });
}

function enqueue(payload) {
  syncQueue.push(payload);
  localStorage.setItem('checksheet_queue', JSON.stringify(syncQueue));
}

function processQueue() {
  if (!navigator.onLine) return;
  syncQueue = JSON.parse(localStorage.getItem('checksheet_queue') || '[]');
  if (syncQueue.length === 0) { updateSyncStatus('All synced'); return; }

  const next = syncQueue.shift();
  fetch(SAVE_URL, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: next
  }).then(() => {
    localStorage.setItem('checksheet_queue', JSON.stringify(syncQueue));
    // continue with remaining
    setTimeout(processQueue, 200);
  }).catch(() => {
    // if failed, put it back and stop
    syncQueue.unshift(next);
    localStorage.setItem('checksheet_queue', JSON.stringify(syncQueue));
    updateSyncStatus('Sync failed – will retry');
  });
}

window.addEventListener('online', () => { updateSyncStatus('Online — syncing queued changes'); processQueue(); });
window.addEventListener('offline', () => { updateSyncStatus('Offline'); });

function updateSyncStatus(text) {
  syncStatusEl.textContent = 'Status: ' + text;
}

// Manual force sync button
forceSyncBtn.addEventListener('click', () => {
  const payload = JSON.stringify(collectFormData());
  enqueue(payload);
  processQueue();
});

// ------------------ RESTORE LOCAL DATA ---------------------
function restoreLocal() {
  const saved = localStorage.getItem('checksheet_local');
  if (!saved) return;
  let data;
  try { data = JSON.parse(saved); } catch { return; }

  const elements = form.querySelectorAll('input[type="text"], input[type="date"], input[type="checkbox"], textarea');
  elements.forEach(el => {
    const name = el.name || el.id;
    if (!name || !data[name]) return;
    const arr = data[name];
    const same = [...form.querySelectorAll(`[name='${name}'], #${name}`)];
    const index = same.indexOf(el);
    if (el.type === 'checkbox') {
      el.checked = !!arr[index];
    } else {
      el.value = arr[index] || '';
    }
  });
  updateSyncStatus('Restored local data');
}

// --------------------- ATTACH EVENTS -----------------------
function attachListeners() {
  form.querySelectorAll('input[type="text"], input[type="date"], textarea, input[type="checkbox"]').forEach(el => {
    el.addEventListener('input', requestSave);
    el.addEventListener('change', requestSave);
  });
}
attachListeners();

// Initial UI state
updateSyncStatus(navigator.onLine ? 'Online' : 'Offline');

</script>
</body>
</html>
