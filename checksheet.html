<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Construction Check Sheet (Editable with Sign-off + QR Auth)</title>

<!-- jsQR library -->
<script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>

<style>
  body {
    font-family: Arial, Helvetica, sans-serif;
    background: #f1f1f1;
    padding: 20px;
  }

  .container {
    max-width: 900px;
    margin: auto;
    background: white;
    padding: 20px;
    border-radius: 12px;
    box-shadow: 0 0 10px #ccc;
  }

  h2 {
    text-align: center;
    margin-bottom: 20px;
  }

  .section-header {
    background: #c8e6c9;
    padding: 12px 8px 8px 8px;
    font-weight: bold;
    border-radius: 4px;
    margin-top: 30px;
    position: relative;
  }

  /* Sign-off area styling */
  .signoff {
    background: #a5d6a7;
    border: 2px solid #388e3c;
    border-radius: 6px;
    padding: 12px;
    margin-top: 8px;
    display: flex;
    gap: 20px;
    align-items: center;
    flex-wrap: wrap;
  }
  .signoff label {
    font-weight: 600;
    min-width: 100px;
  }
  .signoff input {
    padding: 6px;
    font-size: 1rem;
    flex: 1 1 180px;
    min-width: 150px;
  }

  .row {
    display: grid;
    grid-template-columns: 1fr 120px 120px;
    gap: 10px;
    padding: 6px 0;
    border-bottom: 1px solid #ddd;
  }

  .row label {
    font-weight: 500;
  }

  input[type="checkbox"] {
    transform: scale(1.3);
    margin-left: 8px;
  }

  input[type="text"], input[type="date"] {
    width: 100%;
    padding: 6px;
  }

  textarea {
    width: 100%;
    padding: 10px;
    height: 80px;
  }

  .submit-container {
    margin-top: 20px;
    text-align: center;
  }

  button {
    background: #39ff14;
    padding: 18px 28px;
    font-size: 20px;
    border: none;
    border-radius: 10px;
    font-weight: bold;
    cursor: pointer;
  }

  /* Add row buttons */
  .add-row-btn {
    margin-top: 10px;
    font-weight: 600;
    cursor: pointer;
    color: #2e7d32;
    background: none;
    border: none;
    font-size: 1rem;
    text-decoration: underline;
  }

  /* LOCKSCREEN overlay styles */
  .locked-overlay {
    position: fixed;
    top: 0; left: 0;
    width: 100vw; height: 100vh;
    background: rgba(0,0,0,0.75);
    display:flex;
    align-items:center;
    justify-content:center;
    z-index: 9999;
  }
  #qr-area {
    background: white;
    padding: 20px;
    border-radius: 12px;
    text-align: center;
    max-width: 360px;
  }
  #qr-video {
    width: 300px;
    border-radius: 8px;
  }

  /* Disabled form container while locked */
  .disabled * {
    pointer-events: none;
    opacity: 0.45;
  }
</style>
</head>
<body>

<!-- QR AUTH LOCK SCREEN -->
<div id="lockscreen" class="locked-overlay">
  <div id="qr-area">
    <h3>Scan your badge to unlock</h3>
    <video id="qr-video" autoplay playsinline></video>
    <p id="qr-status">Waiting for scan...</p>
    <div style="margin-top:12px;">
      <button id="cancelScan" class="add-row-btn">Cancel</button>
    </div>
  </div>
</div>

<form action="/submit-checksheet" method="post" id="checksheet-form">

<div class="container disabled" id="sheet-container">
  <h2>Construction Check-sheet</h2>

  <div class="row">
    <label for="building">Building Number</label>
    <input type="text" id="building" name="building" />
    <div></div>
  </div>

  <div class="row">
    <label for="phase">Phase</label>
    <input type="text" id="phase" name="phase" />
    <div></div>
  </div>

  <div class="row">
    <label for="foreman">Foreman</label>
    <input type="text" id="foreman" name="foreman" />
    <div></div>
  </div>

  <!-- Equipment Information Section -->
  <div class="section-header" id="equipment-info-header">Equipment Information</div>

  <div id="equipment-info-rows">
    <div class="row">
      <label for="elf-0">ELF Completed</label>
      <input type="checkbox" id="elf-0" name="elf[]" />
      <input type="text" name="elf_notes[]" placeholder="Notes" />
    </div>

    <div class="row">
      <label for="labels-0">Labels Installed by QCX: Phenolic / Arc Flash</label>
      <input type="checkbox" id="labels-0" name="labels[]" />
      <input type="text" name="labels_notes[]" placeholder="Notes" />
    </div>
  </div>

  <button type="button" class="add-row-btn" data-section="equipment-info">+ Add Equipment Info Row</button>

  <div class="signoff" id="signoff-equipment-info">
    <label for="signoff-equipment-name">Sign-Off Name:</label>
    <input type="text" id="signoff-equipment-name" name="signoff_equipment_name" placeholder="Name" />
    <label for="signoff-equipment-date">Date:</label>
    <input type="date" id="signoff-equipment-date" name="signoff_equipment_date" />
  </div>

  <!-- Equipment Mounted / Installation Specs Section -->
  <div class="section-header" id="equipment-mounted-header">Equipment Mounted / Installation Specs</div>

  <div id="equipment-mounted-rows">
    <div class="row">
      <label for="clearance-0">6” clearance from walls and panels</label>
      <input type="checkbox" id="clearance-0" name="clearance[]" />
      <input type="text" name="clearance_notes[]" placeholder="Notes" />
    </div>
    <div class="row">
      <label for="coverbolts-0">Remove front cover bolts</label>
      <input type="checkbox" id="coverbolts-0" name="coverbolts[]" />
      <input type="text" name="coverbolts_notes[]" placeholder="Notes" />
    </div>
    <div class="row">
      <label for="shipping-0">Shipping assembly (if required)</label>
      <input type="checkbox" id="shipping-0" name="shipping[]" />
      <input type="text" name="shipping_notes[]" placeholder="Notes" />
    </div>
    <div class="row">
      <label for="protect-0">Apply protect cover to equipment</label>
      <input type="checkbox" id="protect-0" name="protect[]" />
      <input type="text" name="protect_notes[]" placeholder="Notes" />
    </div>
    <div class="row">
      <label for="anchors-0">Anchored using 1/2” concrete wedge anchors</label>
      <input type="checkbox" id="anchors-0" name="anchors[]" />
      <input type="text" name="anchors_notes[]" placeholder="Notes" />
    </div>
    <div class="row">
      <label for="square-0">Housing is mounted squared and leveled</label>
      <input type="checkbox" id="square-0" name="square[]" />
      <input type="text" name="square_notes[]" placeholder="Notes" />
    </div>
  </div>

  <button type="button" class="add-row-btn" data-section="equipment-mounted">+ Add Installation Spec Row</button>

  <div class="signoff" id="signoff-equipment-mounted">
    <label for="signoff-mounted-name">Sign-Off Name:</label>
    <input type="text" id="signoff-mounted-name" name="signoff_mounted_name" placeholder="Name" />
    <label for="signoff-mounted-date">Date:</label>
    <input type="date" id="signoff-mounted-date" name="signoff_mounted_date" />
  </div>

  <!-- Internal Wiring and Termination Specs Section -->
  <div class="section-header" id="internal-wiring-header">Internal Wiring and Termination Specs</div>

  <div id="internal-wiring-rows">
    <div class="row">
      <label for="lineLoad-0">Install proper line/load wiring from nearest panel</label>
      <input type="checkbox" id="lineLoad-0" name="lineLoad[]" />
      <input type="text" name="lineLoad_notes[]" placeholder="Notes" />
    </div>
    <div class="row">
      <label for="primaryHV-0">Primary HV matches (L1-A, L2-B, L3-C)</label>
      <input type="checkbox" id="primaryHV-0" name="primaryHV[]" />
      <input type="text" name="primaryHV_notes[]" placeholder="Notes" />
    </div>
    <div class="row">
      <label for="phaseRotation-0">Verify primary phase rotation</label>
      <input type="checkbox" id="phaseRotation-0" name="phaseRotation[]" />
      <input type="text" name="phaseRotation_notes[]" placeholder="Notes" />
    </div>
    <div class="row">
      <label for="ground-0">Ground installation correct</label>
      <input type="checkbox" id="ground-0" name="ground[]" />
      <input type="text" name="ground_notes[]" placeholder="Notes" />
    </div>
  </div>

  <button type="button" class="add-row-btn" data-section="internal-wiring">+ Add Internal Wiring Row</button>

  <div class="signoff" id="signoff-internal-wiring">
    <label for="signoff-wiring-name">Sign-Off Name:</label>
    <input type="text" id="signoff-wiring-name" name="signoff_wiring_name" placeholder="Name" />
    <label for="signoff-wiring-date">Date:</label>
    <input type="date" id="signoff-wiring-date" name="signoff_wiring_date" />
  </div>

  <!-- Secondary Wiring Section -->
  <div class="section-header" id="secondary-wiring-header">Secondary Wiring</div>

  <div id="secondary-wiring-rows">
    <div class="row">
      <label for="secondaryWires-0">Secondary wires installed to labeling: X1-Black, X2-Red, X3-C, X4-Blue</label>
      <input type="checkbox" id="secondaryWires-0" name="secondaryWires[]" />
      <input type="text" name="secondaryWires_notes[]" placeholder="Notes" />
    </div>
  </div>

  <button type="button" class="add-row-btn" data-section="secondary-wiring">+ Add Secondary Wiring Row</button>

  <div class="signoff" id="signoff-secondary-wiring">
    <label for="signoff-secondary-name">Sign-Off Name:</label>
    <input type="text" id="signoff-secondary-name" name="signoff_secondary_name" placeholder="Name" />
    <label for="signoff-secondary-date">Date:</label>
    <input type="date" id="signoff-secondary-date" name="signoff_secondary_date" />
  </div>

  <!-- Final Checks Section -->
  <div class="section-header" id="final-checks-header">Final Checks</div>

  <div id="final-checks-rows">
    <div class="row">
      <label for="bondedBushing-0">Housing grounded via bonded bushing</label>
      <input type="checkbox" id="bondedBushing-0" name="bondedBushing[]" />
      <input type="text" name="bondedBushing_notes[]" placeholder="Notes" />
    </div>
    <div class="row">
      <label for="bondingJumper-0">Bonding jumper meets code</label>
      <input type="checkbox" id="bondingJumper-0" name="bondingJumper[]" />
      <input type="text" name="bondingJumper_notes[]" placeholder="Notes" />
    </div>
    <div class="row">
      <label for="notesAttached-0">Verify handwritten notes attached</label>
      <input type="checkbox" id="notesAttached-0" name="notesAttached[]" />
      <input type="text" name="notesAttached_notes[]" placeholder="Notes" />
    </div>
  </div>

  <button type="button" class="add-row-btn" data-section="final-checks">+ Add Final Check Row</button>

  <div class="signoff" id="signoff-final-checks">
    <label for="signoff-final-name">Sign-Off Name:</label>
    <input type="text" id="signoff-final-name" name="signoff_final_name" placeholder="Name" />
    <label for="signoff-final-date">Date:</label>
    <input type="date" id="signoff-final-date" name="signoff_final_date" />
  </div>

  <!-- QCX Review Section (non-repeatable) -->
  <div class="section-header" id="qcx-review-header">QCX Review</div>

  <div class="row">
    <label for="qcxName">Name</label>
    <input type="text" id="qcxName" name="qcxName" />
    <div></div>
  </div>

  <div class="row">
    <label for="qcxDate">Date</label>
    <input type="date" id="qcxDate" name="qcxDate" />
    <div></div>
  </div>

  <div class="submit-container">
    <button type="submit">SUBMIT CHECK SHEET</button>
  </div>

</div>

</form>

<script>
  // ======================== CONFIG ===========================
  const QR_CODE_REGEX = /^\d{7}$/; // exactly 7 digits badge code

  // State
  let editingUnlocked = false;
  let qrStream = null;

  // Elements
  const qrVideo = document.getElementById('qr-video');
  const lockscreen = document.getElementById('lockscreen');
  const qrStatus = document.getElementById('qr-status');
  const cancelScanBtn = document.getElementById('cancelScan');
  const sheetContainer = document.getElementById('sheet-container');

  // Sound + speech synthesis setup for unlock feedback
  const unlockAudio = new Audio('https://actions.google.com/sounds/v1/cartoon/clang_and_wobble.ogg');
  function sayNexus() {
    if (!window.speechSynthesis) return;
    const utterance = new SpeechSynthesisUtterance('NEXUS');
    utterance.lang = 'en-US';
    utterance.pitch = 0.6;
    utterance.rate = 0.8;
    window.speechSynthesis.speak(utterance);
  }

  // Start QR Scan
  async function startQRScan() {
    qrStatus.textContent = 'Requesting camera...';
    try {
      qrStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
      qrVideo.srcObject = qrStream;
      qrVideo.play();

      const canvas = document.createElement('canvas');
      const ctx = canvas.getContext('2d');

      const scan = () => {
        if (qrVideo.readyState === qrVideo.HAVE_ENOUGH_DATA) {
          canvas.width = qrVideo.videoWidth;
          canvas.height = qrVideo.videoHeight;
          ctx.drawImage(qrVideo, 0, 0, canvas.width, canvas.height);
          const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
          const code = jsQR(imageData.data, canvas.width, canvas.height);
          if (code) {
            qrStatus.textContent = 'Scanned: ' + code.data;
            handleQrValue(code.data.trim());
            return; // stop scanning
          }
        }
        requestAnimationFrame(scan);
      };
      scan();

    } catch (err) {
      qrStatus.textContent = 'Camera denied or error: ' + err.message;
    }
  }

  function stopQRScan() {
    if (qrStream) {
      qrStream.getTracks().forEach(t => t.stop());
      qrStream = null;
    }
  }

  function handleQrValue(value) {
    if (editingUnlocked) return;

    if (QR_CODE_REGEX.test(value)) {
      unlockEditing();
    } else {
      qrStatus.textContent = 'Unrecognized QR. Please scan a 7-digit badge.';
      // Continue scanning:
      requestAnimationFrame(startQRScan);
    }
  }

  cancelScanBtn.addEventListener('click', () => {
    stopQRScan();
    lockscreen.style.display = 'none';
    // form stays locked, reload page to scan again
  });

  function unlockEditing() {
    editingUnlocked = true;
    stopQRScan();
    lockscreen.style.display = 'none';
    sheetContainer.classList.remove('disabled');
    qrStatus.textContent = 'Unlocked';

    // Play sound and speak "NEXUS"
    unlockAudio.play().catch(() => {});
    sayNexus();
  }

  // On page load, start scanning and lock the form
  window.addEventListener('load', () => {
    lockscreen.style.display = 'flex';
    sheetContainer.classList.add('disabled');
    startQRScan();
  });

  // ------------------ Add row buttons (your existing code) -----------------
  document.querySelectorAll('.add-row-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      const section = btn.getAttribute('data-section');
      const container = document.getElementById(section + '-rows');
      if (!container) return;

      // Clone the last row in the container
      const lastRow = container.querySelector('.row:last-child');
      if (!lastRow) return;

      const newRow = lastRow.cloneNode(true);

      // Clear input values in new row and update IDs
      newRow.querySelectorAll('input').forEach(input => {
        if (input.type === 'checkbox') {
          input.checked = false;
        } else {
          input.value = '';
        }
      });

      // Update label "for" and input id to unique values
      const inputs = newRow.querySelectorAll('input[type="checkbox"], input[type="text"]');
      inputs.forEach((input, index) => {
        const name = input.name; // like elf[] or elf_notes[]
        let baseName = name.replace(/\[\]/, '');
        let count = container.querySelectorAll('.row').length; // current count (starting at 1)

        if (input.type === 'checkbox') {
          input.id = baseName + '-' + count;
          // Update label for attribute
          const label = newRow.querySelector(`label[for^="${baseName}-"]`);
          if (label) label.setAttribute('for', input.id);
        } else if (input.type === 'text') {
          input.id = baseName + '-notes-' + count;
        }
      });

      container.appendChild(newRow);
    });
  });
</script>

</body>
</html>
