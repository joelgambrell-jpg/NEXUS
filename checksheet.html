<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Construction Form with Full Features</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 900px;
      margin: auto;
      padding: 1rem;
    }
    h1, h2 {
      margin-bottom: 0.5rem;
    }
    .row {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-bottom: 0.5rem;
    }
    .row label {
      min-width: 140px;
      user-select: none;
    }
    input[type="text"], input[type="password"] {
      flex: 1;
      padding: 0.25rem;
    }
    .add-row-btn {
      margin-bottom: 1rem;
      cursor: pointer;
      background: #1976d2;
      border: none;
      color: white;
      padding: 0.4rem 0.8rem;
      border-radius: 4px;
      font-size: 0.9rem;
    }
    #change-log {
      white-space: pre-wrap;
      background: #f9f9f9;
      border: 1px solid #ccc;
      padding: 0.5rem;
      height: 120px;
      overflow-y: auto;
      margin-top: 0.5rem;
      font-family: monospace;
      font-size: 0.85rem;
    }
    #change-log[contenteditable="true"] {
      background: #fffbe6;
      border-color: #f1c40f;
    }
    button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    .btn-container {
      margin-top: 1rem;
      display: flex;
      gap: 0.5rem;
      align-items: center;
      flex-wrap: wrap;
    }
    #log-pass-error {
      color: red;
      font-weight: bold;
      margin-left: 1rem;
    }
    /* QR Scanner container */
    #qr-scanner-container {
      margin-top: 1rem;
      border: 2px dashed #1976d2;
      padding: 0.5rem;
      display: none;
      max-width: 320px;
    }
    #qr-video {
      width: 100%;
      border-radius: 4px;
    }
  </style>
</head>
<body>

  <h1>Construction Form</h1>
  <form id="main-form">

    <!-- Equipment Info Section -->
    <h2>Equipment Info</h2>
    <div id="elf-rows"></div>
    <button type="button" class="add-row-btn" data-section="equipment-info">Add Equipment Info Row</button>

    <!-- Equipment Mounted Section -->
    <h2>Equipment Mounted</h2>
    <div id="clearance-rows"></div>
    <button type="button" class="add-row-btn" data-section="equipment-mounted">Add Equipment Mounted Row</button>

    <!-- Internal Wiring Section -->
    <h2>Internal Wiring</h2>
    <div id="lineLoad-rows"></div>
    <button type="button" class="add-row-btn" data-section="internal-wiring">Add Internal Wiring Row</button>

    <!-- Secondary Wiring Section -->
    <h2>Secondary Wiring</h2>
    <div id="secondaryWires-rows"></div>
    <button type="button" class="add-row-btn" data-section="secondary-wiring">Add Secondary Wiring Row</button>

    <!-- Final Checks Section -->
    <h2>Final Checks</h2>
    <div id="bondedBushing-rows"></div>
    <button type="button" class="add-row-btn" data-section="final-checks">Add Final Check Row</button>

    <!-- Example of a static input outside dynamic sections -->
    <h2>Sign Off</h2>
    <label for="sign-off-name">Sign Off Name:</label>
    <input type="text" id="sign-off-name" name="signOffName" placeholder="Enter your name" />

  </form>

  <!-- Change Log Display -->
  <h2>Change Log</h2>
  <div id="change-log" tabindex="0">(No changes recorded)</div>

  <div class="btn-container">
    <button id="unlock-log-btn" type="button">Unlock Change Log (Password)</button>
    <button id="unlock-qr-btn" type="button">Unlock Change Log (QR Code)</button>
    <button id="clear-log-btn" type="button" disabled>Clear Change Log</button>
    <span id="log-pass-error"></span>
  </div>

  <!-- QR Scanner Container -->
  <div id="qr-scanner-container">
    <video id="qr-video"></video>
    <button id="stop-qr-btn" type="button" style="margin-top:0.5rem;">Stop Scanner</button>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>
  <script>
    // === Rolling Change Tracker ===
    const changeLogDiv = document.getElementById('change-log');
    const unlockLogBtn = document.getElementById('unlock-log-btn');
    const unlockQRBtn = document.getElementById('unlock-qr-btn');
    const clearLogBtn = document.getElementById('clear-log-btn');
    const passErrorDiv = document.getElementById('log-pass-error');

    let changeLog = [];

    function loadChangeLog() {
      const saved = localStorage.getItem('constructionChangeLog');
      if (saved) {
        try {
          changeLog = JSON.parse(saved);
        } catch {
          changeLog = [];
        }
        renderChangeLog();
      }
    }

    function saveChangeLog() {
      localStorage.setItem('constructionChangeLog', JSON.stringify(changeLog));
    }

    function renderChangeLog() {
      if (changeLog.length === 0) {
        changeLogDiv.textContent = '(No changes recorded)';
      } else {
        changeLogDiv.textContent = changeLog.join('\n');
        changeLogDiv.scrollTop = changeLogDiv.scrollHeight;
      }
    }

    function logChange(field, oldVal, newVal) {
      if (oldVal === newVal) return;
      const now = new Date().toLocaleString();
      const entry = `[${now}] ${field}: "${oldVal}" â†’ "${newVal}"`;
      changeLog.push(entry);
      saveChangeLog();
      renderChangeLog();
    }

    unlockLogBtn.addEventListener('click', () => {
      const pass = prompt('Enter password to unlock the change log:');
      if (pass === '18436572') {
        unlockChangeLogEditing();
        passErrorDiv.textContent = '';
      } else {
        passErrorDiv.textContent = 'Incorrect password!';
      }
    });

    clearLogBtn.addEventListener('click', () => {
      if (confirm('Are you sure you want to clear the change log?')) {
        changeLog = [];
        saveChangeLog();
        renderChangeLog();
      }
    });

    function unlockChangeLogEditing() {
      changeLogDiv.contentEditable = "true";
      changeLogDiv.style.backgroundColor = '#fffbe6';
      clearLogBtn.disabled = false;
      unlockLogBtn.disabled = true;
      unlockQRBtn.disabled = true;
      stopQRScanner(); // in case it's running
    }

    // === Dynamic form handling ===
    const mainForm = document.getElementById('main-form');

    const dynamicSections = {
      'equipment-info': 'elf',
      'equipment-mounted': 'clearance',
      'internal-wiring': 'lineLoad',
      'secondary-wiring': 'secondaryWires',
      'final-checks': 'bondedBushing'
    };

    // Save form including dynamic rows
    function saveFormData() {
      const formData = {};

      const allInputs = mainForm.querySelectorAll('input, textarea');

      // Collect all dynamic container inputs to exclude from static save
      const dynamicContainers = Object.keys(dynamicSections).map(
        section => document.getElementById(dynamicSections[section] + '-rows')
      ).filter(Boolean);

      const dynamicInputs = new Set();

      dynamicContainers.forEach(container => {
        container.querySelectorAll('input, textarea').forEach(input => {
          dynamicInputs.add(input);
        });
      });

      allInputs.forEach(input => {
        if (dynamicInputs.has(input)) return;

        const key = input.name + (input.id ? `|${input.id}` : '');
        if (input.type === 'checkbox') {
          formData[key] = input.checked;
        } else {
          formData[key] = input.value;
        }
      });

      formData.dynamicRows = {};

      for (const [section, base] of Object.entries(dynamicSections)) {
        const container = document.getElementById(base + '-rows');
        if (!container) continue;

        const rows = container.querySelectorAll('.row');
        formData.dynamicRows[section] = [];

        rows.forEach(row => {
          const checkbox = row.querySelector(`input[type="checkbox"][name^="${base}"]`);
          const notes = row.querySelector(`input[type="text"][name^="${base}_notes"]`);

          formData.dynamicRows[section].push({
            checked: checkbox ? checkbox.checked : false,
            notes: notes ? notes.value : ''
          });
        });
      }

      localStorage.setItem('constructionFormData', JSON.stringify(formData));
    }

    function clearDynamicRows(section) {
      const base = dynamicSections[section];
      const container = document.getElementById(base + '-rows');
      if (!container) return;
      container.innerHTML = '';
    }

    function addDynamicRow(section, checked = false, notes = '') {
      const base = dynamicSections[section];
      const container = document.getElementById(base + '-rows');
      if (!container) return;

      const index = container.querySelectorAll('.row').length;

      const newRow = document.createElement('div');
      newRow.className = 'row';

      const label = document.createElement('label');
      label.setAttribute('for', `${base}-${index}`);
      label.textContent = `${capitalizeWords(base)} item ${index + 1}`;

      const checkbox = document.createElement('input');
      checkbox.type = 'checkbox';
      checkbox.id = `${base}-${index}`;
      checkbox.name = `${base}[]`;
      checkbox.checked = checked;

      const notesInput = document.createElement('input');
      notesInput.type = 'text';
      notesInput.name = `${base}_notes[]`;
      notesInput.placeholder = 'Notes';
      notesInput.value = notes;

      newRow.appendChild(label);
      newRow.appendChild(checkbox);
      newRow.appendChild(notesInput);
      container.appendChild(newRow);

      lastValues.set(checkbox, checkbox.checked);
      lastValues.set(notesInput, notesInput.value);

      checkbox.addEventListener('change', () => {
        const oldVal = lastValues.get(checkbox);
        const newVal = checkbox.checked;
        if (oldVal !== newVal) {
          const fieldName = label.textContent + ' (checked)';
          logChange(fieldName, oldVal, newVal);
          lastValues.set(checkbox, newVal);
          saveFormData();
        }
      });

      notesInput.addEventListener('change', () => {
        const oldVal = lastValues.get(notesInput);
        const newVal = notesInput.value;
        if (oldVal !== newVal) {
          const fieldName = label.textContent + ' (notes)';
          logChange(fieldName, oldVal, newVal);
          lastValues.set(notesInput, newVal);
          saveFormData();
        }
      });
    }

    function loadFormData() {
      const savedData = localStorage.getItem('constructionFormData');
      if (!savedData) return;

      let formData;
      try {
        formData = JSON.parse(savedData);
      } catch {
        return;
      }

      const allInputs = mainForm.querySelectorAll('input, textarea');

      allInputs.forEach(input => {
        const key = input.name + (input.id ? `|${input.id}` : '');

        // Skip dynamic row inputs, handled separately
        if (formData.dynamicRows) {
          for (const section of Object.keys(dynamicSections)) {
            const base = dynamicSections[section];
            if (key.startsWith(base)) {
              return;
            }
          }
        }

        if (!(key in formData)) return;

        if (input.type === 'checkbox') {
          input.checked = formData[key];
        } else {
          input.value = formData[key];
        }

        lastValues.set(input, getInputValue(input));
      });

      if (formData.dynamicRows) {
        for (const [section, rows] of Object.entries(formData.dynamicRows)) {
          clearDynamicRows(section);
          rows.forEach(rowData => {
            addDynamicRow(section, rowData.checked, rowData.notes);
          });
        }
      }
    }

    function getInputValue(input) {
      if (input.type === 'checkbox') return input.checked;
      return input.value;
    }

    const lastValues = new Map();

    window.addEventListener('load', () => {
      loadFormData();

      const staticInputs = mainForm.querySelectorAll('input, textarea');

      staticInputs.forEach(input => {
        lastValues.set(input, getInputValue(input));
        input.addEventListener('change', () => {
          const oldVal = lastValues.get(input);
          const newVal = getInputValue(input);
          if (oldVal !== newVal) {
            const label = mainForm.querySelector(`label[for="${input.id}"]`);
            const fieldName = label ? label.textContent.trim() : input.name || input.id;
            logChange(fieldName, oldVal, newVal);
            lastValues.set(input, newVal);
            saveFormData();
          }
        });
      });
    });

    const addRowButtons = document.querySelectorAll('.add-row-btn');
    addRowButtons.forEach(btn => {
      btn.addEventListener('click', () => {
        if (btn.disabled) return;
        const section = btn.getAttribute('data-section');
        addDynamicRow(section, false, '');
        saveFormData();
      });
    });

    function capitalizeWords(str) {
      return str.replace(/([A-Z])/g, ' $1').replace(/^./, s => s.toUpperCase());
    }

    // === QR code scanner unlock ===

    const qrScannerContainer = document.getElementById('qr-scanner-container');
    const qrVideo = document.getElementById('qr-video');
    const stopQRBtn = document.getElementById('stop-qr-btn');
    let videoStream = null;
    let qrScanInterval = null;

    unlockQRBtn.addEventListener('click', () => {
      startQRScanner();
    });

    stopQRBtn.addEventListener('click', () => {
      stopQRScanner();
    });

    function startQRScanner() {
      passErrorDiv.textContent = '';
      if (qrScannerContainer.style.display === 'block') return; // already running
      qrScannerContainer.style.display = 'block';

      navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } })
        .then(stream => {
          videoStream = stream;
          qrVideo.srcObject = stream;
          qrVideo.setAttribute('playsinline', true); // for iOS safari
          qrVideo.play();

          qrScanInterval = setInterval(scanQRCode, 300);
        })
        .catch(err => {
          passErrorDiv.textContent = 'Camera access denied or not available.';
          stopQRScanner();
        });
    }

    function stopQRScanner() {
      if (qrScanInterval) {
        clearInterval(qrScanInterval);
        qrScanInterval = null;
      }
      if (videoStream) {
        videoStream.getTracks().forEach(track => track.stop());
        videoStream = null;
      }
      qrScannerContainer.style.display = 'none';
      qrVideo.pause();
      qrVideo.srcObject = null;
    }

    function scanQRCode() {
      if (qrVideo.readyState !== qrVideo.HAVE_ENOUGH_DATA) {
        return;
      }

      const canvas = document.createElement('canvas');
      canvas.width = qrVideo.videoWidth;
      canvas.height = qrVideo.videoHeight;
      const ctx = canvas.getContext('2d');
      ctx.drawImage(qrVideo, 0, 0, canvas.width, canvas.height);

      const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
      const code = jsQR(imageData.data, canvas.width, canvas.height);

      if (code) {
        if (code.data === '18436572') { // password encoded in QR code
          unlockChangeLogEditing();
          passErrorDiv.textContent = '';
          stopQRScanner();
        } else {
          passErrorDiv.textContent = 'Invalid QR code.';
        }
      }
    }

  </script>

</body>
</html>
