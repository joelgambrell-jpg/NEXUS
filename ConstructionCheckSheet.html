<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>QR Unlock – Google Sheet Logging</title>

<style>
  :root{
    --bg:#cc0000;
    --panel:#ffffff;
    --shadow:#900000;
    --overlay:rgba(0,0,0,0.75);
    --accent:#4caf50;
    --danger:#ff5252;
  }

  *{ box-sizing:border-box; }

  body{
    margin:0;
    font-family: Arial, Helvetica, sans-serif;
    background: var(--bg);
    min-height:100vh;
    display:flex;
    flex-direction:column;
  }

  .layout{
    width: calc(100vw - 40px);
    height: calc(95vh);
    margin: 20px auto;
    display:flex;
  }

  .container{
    position:relative;
    background: var(--panel);
    flex:1;
    border-radius:12px;
    box-shadow:0 0 15px var(--shadow);
    overflow:hidden;
  }

  iframe{
    width:100%;
    height:100%;
    border:none;
  }

  #lock-overlay{
    position:absolute;
    inset:0;
    background: var(--overlay);
    z-index:10;
    display:flex;
    flex-direction:column;
    align-items:center;
    justify-content:center;
    color:#fff;
    font-weight:800;
    gap:14px;
    padding:20px;
    text-align:center;
  }

  #qr-reader{
    width:min(480px, 92vw);
    aspect-ratio:1/1;
    border:2px solid var(--accent);
    border-radius:8px;
    background:#111;
  }

  #access-granted{
    color:var(--accent);
    font-size:1.3rem;
    font-weight:900;
    display:none;
  }

  .manual-unlock{
    display:grid;
    grid-template-columns:1fr auto;
    gap:10px;
    width:min(520px, 92vw);
  }

  .manual-unlock input{
    padding:10px;
    border-radius:10px;
    border:none;
    font-weight:800;
  }

  .manual-unlock button{
    padding:10px 14px;
    border:none;
    border-radius:10px;
    background:var(--accent);
    font-weight:900;
    cursor:pointer;
  }

  .overlay-actions{
    display:flex;
    gap:10px;
  }

  .overlay-actions button{
    padding:10px 14px;
    border:none;
    border-radius:10px;
    font-weight:900;
    cursor:pointer;
  }

  .danger{
    background:var(--danger);
    color:#200;
  }

  footer{
    text-align:center;
    color:#fff;
    font-size:0.9rem;
    margin-bottom:12px;
  }
</style>
</head>

<body>

<div class="layout">
  <div class="container">
    <iframe
      src="https://docs.google.com/spreadsheets/d/1uTBgh3jCQLv8iNrwnnxgl3MoTwzbcUYt2uTrtYdWCuw/edit?usp=sharing"
      title="Google Sheet"
    ></iframe>

    <div id="lock-overlay">
      <div>Scan QR code on badge to gain access</div>

      <div id="qr-reader"></div>

      <div id="access-granted">Access Granted</div>

      <div class="manual-unlock">
        <input id="manual-code" maxlength="7" placeholder="Manual 7-digit badge code">
        <button id="manual-unlock-btn">Unlock</button>
      </div>

      <div class="overlay-actions">
        <button id="retry-camera">Retry Camera</button>
        <button id="stop-camera" class="danger">Stop Camera</button>
      </div>
    </div>
  </div>
</div>

<script src="https://unpkg.com/html5-qrcode"></script>

<script type="module">
  const SHEET_WEBAPP_URL = "https://script.google.com/macros/s/AKfycbwIFiuJXfvk-FlHqnF5IyBTqFBQ0LXh-mZUeP5kAGeMyn_RMILKgJqVlNlFjrnE4B7Tcg/exec";

  let qrScanner = null;

  const manualInput = document.getElementById("manual-code");
  const unlockMsg = document.getElementById("access-granted");

  function isValid(code){
    return /^\d{7}$/.test(code);
  }

  function getDeviceId(){
    const k="nexus_device_id_v1";
    let id=localStorage.getItem(k);
    if(!id){
      id=crypto.randomUUID();
      localStorage.setItem(k,id);
    }
    return id;
  }

  async function sendToSheet(payload){
    if(!SHEET_WEBAPP_URL || !navigator.onLine) return;
    await fetch(SHEET_WEBAPP_URL,{
      method:"POST",
      headers:{ "Content-Type":"text/plain;charset=utf-8" },
      body:JSON.stringify(payload)
    });
  }

  async function unlock(){
    unlockMsg.style.display="block";
    setTimeout(()=>document.getElementById("lock-overlay").style.display="none",1000);
    if(qrScanner) await qrScanner.stop();
  }

  async function handleCode(code, method){
    const valid=isValid(code);

    await sendToSheet({
      code,
      valid,
      method,
      deviceId:getDeviceId(),
      scannedAtLocalISO:new Date().toISOString()
    });

    if(valid) unlock();
  }

  async function startScanner(){
    qrScanner=new Html5Qrcode("qr-reader");
    await qrScanner.start(
      { facingMode:"environment" },
      { fps:10, qrbox:360 },
      txt=>handleCode(txt.trim(),"qr")
    );
  }

  document.getElementById("manual-unlock-btn").onclick=()=>{
    const code=manualInput.value.trim();
    if(code) handleCode(code,"manual");
  };

  document.getElementById("retry-camera").onclick=startScanner;
  document.getElementById("stop-camera").onclick=()=>qrScanner?.stop();

  startScanner();
</script>

<footer>
© Intellectual Property of NEXUS Data Science. Created in joint venture with ACE Electric.
</footer>

</body>
</html>

