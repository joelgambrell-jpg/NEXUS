<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Google Doc Access with QR Unlock</title>

<style>
  :root{
    --bg:#cc0000;
    --panel:#ffffff;
    --shadow:#900000;
    --overlay:rgba(0,0,0,0.75);
    --accent:#4caf50;
  }

  body{
    margin:0;
    font-family: Arial, Helvetica, sans-serif;
    background: var(--bg);
    min-height:100vh;
    display:flex;
    flex-direction:column;
  }

  /* Main layout: doc left, log right */
  .layout{
    width: calc(100vw - 40px);
    height: calc(95vh);
    margin: 20px auto;
    display:flex;
    gap:16px;
    align-items:stretch;
  }

  .container{
    position:relative;
    background: var(--panel);
    flex: 1 1 auto;
    border-radius: 12px;
    box-shadow: 0 0 15px var(--shadow);
    overflow:hidden;
    min-width: 320px;
  }

  iframe.google-doc-embed{
    border:none;
    width:100%;
    height:100%;
  }

  /* Always-visible right-side panel */
  #persistent-log{
    flex: 0 0 380px;            /* right column width */
    background: rgba(0,0,0,0.85);
    border-radius: 12px;
    box-shadow: 0 0 15px rgba(0,0,0,0.4);
    color:#fff;
    padding: 12px;
    display:flex;
    flex-direction:column;
    min-width: 300px;
  }

  .scan-panel{
    display:grid;
    grid-template-columns: 1fr auto;
    gap:10px;
    align-items:center;
  }

  .scan-panel .title{
    font-size:1.05rem;
    font-weight:800;
    text-align:left;
  }

  .scan-panel .actions{
    display:flex;
    gap:8px;
    flex-wrap:wrap;
    justify-content:flex-end;
  }

  .scan-panel button{
    appearance:none;
    border:0;
    border-radius:10px;
    padding:8px 10px;
    font-weight:800;
    cursor:pointer;
  }

  #clear-log{ background:#fff; color:#000; }
  #pause-log{ background: var(--accent); color:#001a00; }
  #pause-log.paused{ background:#ffc107; color:#2a1c00; }
  #toggle-cloud{ background:#2196f3; color:#00142a; }
  #toggle-cloud.off{ background:#9e9e9e; color:#111; }

  .status-line{
    margin-top:10px;
    font-size:0.9rem;
    font-weight:800;
    opacity:0.95;
  }

  .log-hint{
    margin-top:6px;
    font-size:0.85rem;
    font-weight:700;
    color: rgba(255,255,255,0.85);
  }

  #scan-log{
    margin-top:10px;
    border: 1px solid rgba(255,255,255,0.25);
    border-radius:10px;
    background: rgba(255,255,255,0.06);
    padding:10px 10px;
    overflow:auto;
    flex: 1 1 auto;            /* fill remaining height */
    min-height: 120px;
  }

  .log-row{
    display:grid;
    grid-template-columns: 140px 1fr;
    gap:10px;
    padding:6px 0;
    border-bottom:1px solid rgba(255,255,255,0.10);
  }
  .log-row:last-child{ border-bottom:0; }

  .ts{ color: rgba(255,255,255,0.85); font-weight:800; }
  .code{ color:#d6ffd6; word-break:break-word; font-weight:700; }

  /* Lock overlay stays on top of the doc area only */
  #lock-overlay{
    position:absolute;
    inset:0;
    background: var(--overlay);
    z-index: 10;
    display:flex;
    flex-direction:column;
    align-items:center;
    justify-content:center;
    color:#fff;
    font-size:1.5rem;
    font-weight:800;
    text-align:center;
    padding:20px;
    gap:14px;
  }

  #qr-reader{
    width: 480px;
    height: 480px;
    border: 2px solid var(--accent);
    border-radius: 8px;
    background:#111;
  }

  #access-granted{
    font-size:1.25rem;
    color: var(--accent);
    font-weight:900;
    display:none;
  }

  #welcome-text{
    font-size:1.1rem;
    font-weight:800;
  }

  footer.footer{
    text-align:center;
    margin: 0 0 12px 0;
    font-size:0.9rem;
    color:#fff;
  }

  /* Responsive: stack log under doc on narrow screens */
  @media (max-width: 980px){
    .layout{ flex-direction:column; height:auto; }
    #persistent-log{ flex: 0 0 auto; width:100%; min-height: 280px; }
    #qr-reader{ width:min(92vw, 480px); height:min(92vw, 480px); }
    .container{ height: 70vh; }
  }
</style>
</head>

<body>
  <div class="layout">
    <div class="container">
      <iframe
        class="google-doc-embed"
        src="https://docs.google.com/spreadsheets/d/1uTBgh3jCQLv8iNrwnnxgl3MoTwzbcUYt2uTrtYdWCuw/edit?usp=sharing"
        title="Google Sheets Document"
      ></iframe>

      <div id="lock-overlay">
        <div>Scan QR code on badge to gain access</div>
        <div id="qr-reader"></div>
        <div id="access-granted">Access Granted!</div>
        <div id="welcome-text">Welcome to Nexus Construction Check Sheet</div>
      </div>
    </div>

    <!-- Always visible right side scan log -->
    <aside id="persistent-log" aria-label="Live Scan Log">
      <div class="scan-panel">
        <div class="title">Live Scan Log</div>
        <div class="actions">
          <button id="toggle-cloud" class="off" type="button" title="Enable when Firebase is configured">Cloud: OFF</button>
          <button id="pause-log" type="button">Pause</button>
          <button id="clear-log" type="button">Clear</button>
        </div>
      </div>

      <div class="status-line" id="cloud-status">Cloud status: not configured (local logging only)</div>
      <div class="log-hint">Every decoded scan is logged here (timestamp + value). Upload to Firebase is optional and queued.</div>
      <div id="scan-log" aria-live="polite"></div>
    </aside>
  </div>

  <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>

  <!-- Firebase is NOT loaded yet. When ready, follow the instructions in the module script below. -->
  <script type="module">
    /******************************************************************
     * 1) Firebase adapter placeholders (leave as-is until ready)
     ******************************************************************/
    const FIREBASE = {
      configured: false,   // set true after init
      enabled: false,      // Cloud ON/OFF toggle
      app: null,
      db: null,
      // writeScan: async (scanObj) => { ... } // implement when configured
    };

    // WHEN READY FOR FIREBASE:
    // 1) Uncomment imports:
    // import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
    // import { getFirestore, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js";
    //
    // 2) Paste config from Firebase console:
    // const firebaseConfig = { apiKey:"...", authDomain:"...", projectId:"...", ... };
    //
    // 3) Initialize + write function:
    // FIREBASE.app = initializeApp(firebaseConfig);
    // FIREBASE.db = getFirestore(FIREBASE.app);
    // FIREBASE.configured = true;
    // FIREBASE.writeScan = async (scanObj) => {
    //   await addDoc(collection(FIREBASE.db, "scans"), { ...scanObj, createdAt: serverTimestamp() });
    // };

    /******************************************************************
     * 2) Elements
     ******************************************************************/
    const lockOverlay = document.getElementById('lock-overlay');
    const accessGrantedMsg = document.getElementById('access-granted');

    const scanLogEl = document.getElementById('scan-log');
    const clearBtn = document.getElementById('clear-log');
    const pauseBtn = document.getElementById('pause-log');
    const cloudBtn = document.getElementById('toggle-cloud');
    const cloudStatus = document.getElementById('cloud-status');

    let qrScanner;

    /******************************************************************
     * 3) Scan logging settings
     ******************************************************************/
    const MAX_LOG_ROWS = 300;
    const DUPLICATE_WINDOW_MS = 2000;

    let isPaused = false;
    let lastSeen = new Map(); // code -> last timestamp

    function nowTimestamp(){
      const d = new Date();
      return d.toLocaleString(undefined, {
        year:"numeric", month:"2-digit", day:"2-digit",
        hour:"2-digit", minute:"2-digit", second:"2-digit"
      });
    }

    function appendLog(code, note=""){
      if (isPaused) return;

      const row = document.createElement("div");
      row.className = "log-row";

      const ts = document.createElement("div");
      ts.className = "ts";
      ts.textContent = nowTimestamp();

      const value = document.createElement("div");
      value.className = "code";
      value.textContent = note ? `${code} (${note})` : code;

      row.appendChild(ts);
      row.appendChild(value);

      scanLogEl.prepend(row);

      while (scanLogEl.children.length > MAX_LOG_ROWS){
        scanLogEl.removeChild(scanLogEl.lastElementChild);
      }
    }

    function shouldLog(code){
      const t = Date.now();
      const last = lastSeen.get(code);
      if (last && (t - last) < DUPLICATE_WINDOW_MS) return false;

      lastSeen.set(code, t);

      if (lastSeen.size > 700){
        for (const [k, v] of lastSeen){
          if (t - v > 60000) lastSeen.delete(k);
        }
      }
      return true;
    }

    /******************************************************************
     * 4) Device ID (helps identify source device in Firebase)
     ******************************************************************/
    const DEVICE_KEY = "nexus_device_id_v1";
    function getDeviceId(){
      let id = localStorage.getItem(DEVICE_KEY);
      if (!id){
        id = (crypto?.randomUUID?.() || (`dev-${Math.random().toString(16).slice(2)}-${Date.now()}`));
        try { localStorage.setItem(DEVICE_KEY, id); } catch {}
      }
      return id;
    }

    /******************************************************************
     * 5) Queue (persists on device; flushes when cloud enabled)
     ******************************************************************/
    const QUEUE_KEY = "nexus_scan_queue_v1";

    function loadQueue(){
      try { return JSON.parse(localStorage.getItem(QUEUE_KEY) || "[]"); }
      catch { return []; }
    }

    function saveQueue(queue){
      try { localStorage.setItem(QUEUE_KEY, JSON.stringify(queue)); } catch {}
    }

    async function enqueueScan(scanObj){
      const q = loadQueue();
      q.unshift(scanObj);
      if (q.length > 1000) q.length = 1000;
      saveQueue(q);
    }

    function setCloudUI(){
      if (!FIREBASE.configured){
        cloudBtn.classList.add("off");
        cloudBtn.textContent = "Cloud: OFF";
        cloudStatus.textContent = "Cloud status: not configured (local logging only)";
        return;
      }

      if (FIREBASE.enabled){
        cloudBtn.classList.remove("off");
        cloudBtn.textContent = "Cloud: ON";
        cloudStatus.textContent = "Cloud status: enabled (uploads + queue flush active)";
      } else {
        cloudBtn.classList.add("off");
        cloudBtn.textContent = "Cloud: OFF";
        cloudStatus.textContent = "Cloud status: configured but disabled (queueing only)";
      }
    }

    async function flushQueue(){
      if (!FIREBASE.configured || !FIREBASE.enabled || typeof FIREBASE.writeScan !== "function") return;
      if (!navigator.onLine) return;

      const q = loadQueue();
      if (!q.length) return;

      // Oldest -> newest for upload order
      const items = q.slice().reverse();

      const remaining = [];
      for (const item of items){
        try {
          await FIREBASE.writeScan(item);
        } catch {
          remaining.push(item);
        }
      }

      // Store remaining newest-first again
      saveQueue(remaining.reverse());
    }

    async function maybeCloudRecord(scanObj){
      await enqueueScan(scanObj);
      await flushQueue();
    }

    window.addEventListener("online", flushQueue);

    /******************************************************************
     * 6) Unlock behavior (hides only the overlay; log stays visible)
     ******************************************************************/
    function unlockAccess(){
      accessGrantedMsg.style.display = "block";
      setTimeout(() => { lockOverlay.style.display = "none"; }, 1200);
      if (qrScanner) qrScanner.stop();
    }

    /******************************************************************
     * 7) Scan callback (logs + queues + optional Firebase)
     ******************************************************************/
    const onScanSuccess = async (decodedText) => {
      const code = (decodedText || "").trim();
      if (!code) return;
      if (!shouldLog(code)) return;

      const isValid = /^\d{7}$/.test(code);
      appendLog(code, isValid ? "valid" : "invalid");

      const scanObj = {
        code,
        valid: isValid,
        scannedAtLocal: new Date().toISOString(),
        deviceId: getDeviceId()
      };

      await maybeCloudRecord(scanObj);

      if (isValid) unlockAccess();
    };

    function startScanner(){
      qrScanner = new Html5Qrcode("qr-reader");
      const config = { fps: 10, qrbox: { width: 360, height: 360 } };

      qrScanner.start({ facingMode: "environment" }, config, onScanSuccess)
        .catch(() =>
          qrScanner.start({ facingMode: "user" }, config, onScanSuccess)
            .catch(() => alert("Failed to start camera for QR scanning. Please check permissions."))
        );
    }

    /******************************************************************
     * 8) Controls
     ******************************************************************/
    clearBtn.addEventListener("click", () => {
      scanLogEl.innerHTML = "";
      lastSeen.clear();
      localStorage.removeItem(QUEUE_KEY);
      appendLog("Cleared log + local queue", "system");
    });

    pauseBtn.addEventListener("click", () => {
      isPaused = !isPaused;
      pauseBtn.classList.toggle("paused", isPaused);
      pauseBtn.textContent = isPaused ? "Resume" : "Pause";
    });

    cloudBtn.addEventListener("click", async () => {
      if (!FIREBASE.configured){
        appendLog("Cloud not configured yet", "system");
        setCloudUI();
        return;
      }
      FIREBASE.enabled = !FIREBASE.enabled;
      setCloudUI();
      if (FIREBASE.enabled) await flushQueue();
    });

    /******************************************************************
     * 9) Boot
     ******************************************************************/
    window.addEventListener("load", () => {
      appendLog("Scanner initializing...", "system");
      setCloudUI();
      startScanner();
    });
  </script>

  <footer class="footer">
    Â© Intellectual Property of NEXUS Data Science. Created in joint venture with ACE Electric. All rights reserved.
  </footer>
</body>
</html>
